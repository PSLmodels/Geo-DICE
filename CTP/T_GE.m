clc
clear;
initial;

global	K0 Tat0 Tlo0 Mat0 Mup0 Mlo0 a0 g0 ag1 Sig0 Eland
global	S L A T gama t m coefm deltaT Fex
global	deltarf
global  TrigTemp Wm
global  nuG Geffective

    m = 200;
    ag1 = ag0;
    TPnxt = 2;
    
%	Climate Sensitivity
    deltaT = 3;
   
%	Uncertainty in Geoengineering
     nuG = 0.03;
     
%   State space:
    S = zeros(9, T);
    %S(1, t): Capital "K" at time t
    %S(2, t): Atmospheric Temperature "Tat" at time t
    %S(3, t): Lower ocean Temperature "Tlo" at time t
    %S(4, t): Atmospheric Carbon Concentration "Mat" at time t
    %S(5, t): Upper Ocean Carbon Concentration "Mup" at time t
    %S(6, t): Lower Ocean Carbon Concentration "Mlo" at time t
    %S(7, t): Gross Economic Output "Y" at time t
    %S(8, t): Emissions "E" at time t
    %S(9, t): Radiative Forcings "F" at time t
    
%   Optimal policy (GHG Reduction Rate %) "a" at state i at time t
    GEx = zeros(1, T);
    
%	Coefficient of aaproximate value function    
    % Climate Sensitivity
        %coefm(m, :) = [8.09795469915116,7.86642190240119,7.70769937727337,7.59637328144739,7.51442911484453,7.45602246056651,7.40739921931938,7.37662824774414,7.35040158563260,7.32964474685071,7.31151304833948,7.29896738199643,7.28757609755205,7.27786548677348,7.26941272036160,7.26187804140411,7.25500645680431,7.24858227459197,7.24242617867000,7.23639869707430,7.23038552176545,7.22426553304983,7.21791163142598,7.21119003989907,7.20395822803288,7.19606216873230,7.18733314916316,7.17758378385944,7.16660405235807,7.15415655812419,7.13997086001928,7.12373782866323,7.10510267754833,7.08365677816870,7.05892892068797,7.03037446740935,6.99736382995671,6.95916792798245,6.91494278532762,6.86370933158226,6.80433341180034,6.73549942868051,6.65568220915143,6.56311186225130,6.45573425619610,6.33116860919896,6.18665069982019,6.01897231240157,5.82441250707790,5.59865204679883,5.33668161451341,5.03268210524733,4.67990468451176,4.27052025825449,3.79543390618845,3.24409901798740,2.60427280284633,1.86174778209685,0.999998655453628,0];
	% Carbon Sink
        %coefm(m, :) = [8.09592900423901,7.86454786548041,7.70739219714700,7.59472975904427,7.51464093509754,7.45563980151163,7.41125005332836,7.37642032502857,7.35069256038928,7.32987519010378,7.31268641870278,7.29871102128804,7.28754176349038,7.27779052549381,7.26931208552046,7.26177455957988,7.25491742170905,7.24852849278199,7.24242872448823,7.23646201415902,7.23048977340713,7.22439655704433,7.21805975906551,7.21134851504434,7.20412245367240,7.19622861031812,7.18749923387621,7.17774808888058,7.16676520235896,7.15431367001598,7.14012347949694,7.12388549544942,7.10524570867736,7.08379468631880,7.05906170320407,7.03050226570700,6.99748672148866,6.95928564789895,6.91505650308524,6.86381836004589,6.80443779027057,6.73559934777723,6.65577654229694,6.56320326940766,6.45582132538991,6.33125071351133,6.18672752923550,6.01904460154567,5.82448022045877,5.59871532419744,5.33673575266696,5.03273767110046,4.67995503557364,4.27056247043106,3.79547029516937,3.24412925150840,2.60429641548255,1.86176398372986,0.999998560102196,0];
    % Econ Loss
        coefm(m, :) = [8.15299659813231,7.91106970632532,7.73643795504937,7.61768560170720,7.54143657644089,7.47437924042791,7.43045466403309,7.39375037125142,7.36501926813813,7.34209721567396,7.32350775992505,7.30820425396581,7.29539193308102,7.28446295986432,7.27496416354116,7.26658028428471,7.25903120743726,7.25206566487208,7.24548754844078,7.23911258336310,7.23279306980089,7.22640460146730,7.21981564021377,7.21288783327461,7.20547478311988,7.19741864782365,7.18854808139831,7.17867295242671,7.16758118955232,7.15503397829193,7.14075884367155,7.12444614966751,7.10573916937910,7.08422845720982,7.05944258861058,7.03083594827341,6.99777857941132,6.95953986641100,6.91527507861152,6.86400718560656,6.80459832896084,6.73573629496933,6.65589182907641,6.56329518144276,6.45589593171020,6.33130999028009,6.18677324666753,6.01907837607902,5.82450576447651,5.59872810256450,5.33674422232479,5.03273722758740,4.67994446843957,4.27055018689390,3.79545757185902,3.24411790959347,2.60429539123651,1.86176263001082,0.999998382723949,0];
%	Weather Shocks
    Wm = 1;
    
%	Extreme Event
    % Trigger Temperature
    TrigTemp = 4.27;

%   Initial State
    y0 = A(1) * (K0 ^ gama) * L(1) ^ (1 - gama);
    Em0 = Sig0 * (1 - a0) * y0 + Eland(1);
    F0 = (deltarf * ((log(Mat0) - log(596.4)) / log(2)) + Fex(1)) * (1 - Geffective * g0);
    S(:, 1) = [K0, Tat0, Tlo0, Mat0, Mup0, Mlo0, y0, Em0, F0];
    [S(:, 2), Costs] = T_NextState(S(:, 1), a0, 0, 1, deltaT, nuG, Wm, 0);
    
    lb = [0; 0];
    act0 = [a0; g0];
    
for t = 2:1:T-3
    
    ub = [1; 1.5];
	myoptions = optimset('Display', 'off','FunValCheck','on','algorithm','sqp', 'MaxFunEvals', 1e5, 'TolX', 1e-9, 'TolCon', 1e-6, 'TolFun', 1e-4);
	[aopt0, fval0] = fmincon(@T_fun,act0,[],[],[],[],lb,ub,[], myoptions);
    GEx(t) = aopt0(2);
    
	ub = [1; 0];
	[aopt1, fval1] = fmincon(@T_fun,act0,[],[],[],[],lb,ub,[], myoptions);
    [S(:, t + 1), Costs] = T_NextState(S(:, t), aopt1(1), aopt1(2), t, deltaT, nuG, Wm, 0);
end
    