
clc
clear;
initial;

global A K0 gama L Sig0 a0 Eland  Mat0 Fex Geffective g0 ag0
global aa0 lambda bprice theta1 theta2 Mup0 Mlo0 Tat0 Tlo0 deltarf theta3 thetaGE
global deltaT nuG TP
global Dact t Sd Wm

prompt = '0:No Geoengineering, 1:Geoengineering: 2:Replication: ';
GE = input(prompt);

prompt = 'Tipping point Type: 1:CS=4, 2:CS=5, 3:CS=6, 4:C=0.75, 5:C=0.5, 6:C=0.25, 7:dm = 1%:';
TP = input(prompt);

% Initial State
y0 = A(1) * (K0 ^ gama) * L(1) ^ (1 - gama);
Em0 = Sig0 * (1 - a0) * y0 + Eland(1);
F0 = (deltarf * ((log(Mat0) - log(596.4)) / log(2)) + Fex(1)) * (1 - Geffective * g0 * GE);
Sa0 = [K0, Tat0, Tlo0, Mat0, Mup0, Mlo0, y0, Em0, F0, 0];
    

% Trigger Temperature
TrigTemp = 4.27;
Tm = 12;
Sd = zeros(10, Tm);
Sd(:, 1) = Sa0;
Ss = zeros(10, Tm);
Ss(:, 1) = Sa0;
SCostd = zeros(3, Tm);
SCosts = zeros(3, Tm);
DWIa = zeros(Tm, 1);
DWIg = zeros(Tm, 1);
D1a = zeros(Tm, 1);
D1g = zeros(Tm, 1);
MHEa = zeros(Tm, 1);
MHEg = zeros(Tm, 1);
IDRa = zeros(Tm, 1);
IDRg = zeros(Tm, 1);
Abt = zeros (Tm, 10);
Wm = 1;
nuG = 0.03; 

if GE == 2
    Dact = [0.00500000000000000,0.146610186555981,0.171961351640265,0.199153446403057,0.227905401975692,0.258103015010689,0.289785139277661,0.323027957834189,0.357949544772756,0.394164214329573,0.431899334497822,0.471398223499237,0.513030827231534,0.557044404638270,0.603679653095404,0.653277468214659,0.706221039228965,0.762849816721083,0.823996112477514,0.890335751151572,0.962834397026114,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];
    Dcoef = [8.09838838325021,7.86728143882789,7.70861287911452,7.59667210383102,7.51584936798973,7.45629025230744,7.41157102507663,7.37739319180705,7.35081747796059,7.32976404357283,7.31279515980262,7.29887469755149,7.28724580032981,7.27734594560898,7.26874903165472,7.26112522874932,7.25421267838187,7.24779721653940,7.24169763365763,7.23575454725463,7.22982199016069,7.22376177008855,7.21745006068791,7.21076234589978,7.20356019270139,7.19569118427646,7.18698703616538,7.17726053081000,7.16630160892499,7.15387275699724,7.13970370624316,7.12348538237248,7.10486299677676,7.08342813447323,7.05870966450794,7.03016326928531,6.99715935775668,6.95896909146345,6.91474821108105,6.86351830255334,6.80414508552761,6.73531324128492,6.65549722022978,6.56292738055560,6.45555070568612,6.33098522804009,6.18646714694904,6.01878946616568,5.82423078850294,5.59847268619068,5.33650381180874,5.03250862075444,4.67973823386048,4.27036057243850,3.79528643692840,3.24396766902518,2.60416291151144,1.86166576732533,0.999998676549023,0];
    if TP == 2
        Sact = [0.00500000000000000,0.152671296807880,0.180494642223707,0.210906906129752,0.261796005736373,0.301087463095193,0.341730011218417,0.384015358074570,0.428109805863885,0.473837541238956,0.521515476055411,0.571551986235945,0.624323415282695,0.680341835543791,0.740043501317647,0.804426431311285,0.874049901516793,0.950455771483819,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];
        Scoef = [8.09692932784173,7.86686863711217,7.70846894304173,7.59228266037062,7.51502520047103,7.45577730414186,7.41135816836450,7.37648916119944,7.35088848039807,7.33010292742922,7.31331342901181,7.29950889548160,7.28795641652375,7.27809691798830,7.26951203191447,7.26188330628029,7.25494674570600,7.24846999367618,7.24231050279960,7.23629894206317,7.23028862359308,7.22417517276124,7.21782916671074,7.21109713520871,7.20388100790826,7.19598346112089,7.18725696397533,7.17750529741299,7.16653010371137,7.15407999804756,7.13989513210475,7.12366241135996,7.10502297884757,7.08357554844008,7.05884396219435,7.03028695602427,6.99727204718239,6.95907268662809,6.91484238612970,6.86360478977271,6.80422371709032,6.73538532307000,6.65556216368239,6.56298659719502,6.45560399720217,6.33103312877737,6.18650997617046,6.01882702599661,5.82426519699367,5.59850306386032,5.33652979365505,5.03253089446288,4.67975556112785,4.27037715567503,3.79529782332845,3.24397926873258,2.60416882643180,1.86167299800045,0.999998661871916,0];
    elseif TP == 5
        Sact = [0.00500000000000000,0.152429424977168,0.182616897761752,0.211468140405236,0.241041319271574,0.271152871679551,0.301828711539420,0.333325460047338,0.365796154560117,0.399088918165839,0.433352585551103,0.469081752318269,0.506416950773026,0.545615982970467,0.587041048319461,0.630799497630183,0.677233505749639,0.727035666717218,0.780151903246269,0.837811091631637,0.900550189151103,0.970011431194900,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];
        Scoef = [8.09855352657296,7.86478349731812,7.70619957026397,7.59562159736059,7.51506327311030,7.45373772321380,7.41045653827636,7.37679322587303,7.35055914902144,7.32977466327363,7.31302684893050,7.29922855759765,7.28770811456916,7.27789413586626,7.26930842776860,7.26169120270506,7.25476939352700,7.24831334450087,7.24220695558446,7.23625916736182,7.23033564661529,7.22426611786604,7.21796813075865,7.21124972044736,7.20401906678863,7.19611727981437,7.18736226265305,7.17762113859110,7.16662675328579,7.15417398790368,7.13997281095708,7.12372946219300,7.10508857858946,7.08363424853202,7.05889449681732,7.03033394855894,6.99731273187403,6.95911054404411,6.91487831146081,6.86363405584915,6.80425020674008,6.73540964724011,6.65558337821660,6.56300589299004,6.45562311873991,6.33104993159412,6.18652412728110,6.01884050135334,5.82427577033339,5.59851153281672,5.33653840148210,5.03253732082878,4.67976338074707,4.27038215756511,3.79530404256314,3.24398403105017,2.60417369697873,1.86167211436784,0.999998490494968,0];
    end
elseif GE == 0
    Dact = [0.00500000000000000,0.145522430287183,0.171378759770023,0.199438363703157,0.229472395878551,0.261353785612965,0.295203958475913,0.331067428870280,0.369115755672170,0.409076266702386,0.451152984077905,0.495656513453828,0.542804490273729,0.592781994219644,0.645707422327068,0.701794748339230,0.760993384670606,0.823609407750691,0.889484922788444,0.959068282089214,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];
    Dcoef = [8.09841438252546,7.86726201793410,7.70855634897937,7.59658669624974,7.51574309132537,7.45617060770659,7.41144477001658,7.37726605571452,7.35069386461020,7.32965358095365,7.31270364594634,7.29880523105238,7.28719917304509,7.27732094871710,7.26874283186395,7.26113363481615,7.25423039436580,7.24781822812149,7.24171548310838,7.23576294449002,7.22981635051855,7.22374985522959,7.21744229777798,7.21076242879792,7.20356874437980,7.19570764256017,7.18701054551146,7.17729031470856,7.16633708950654,7.15391356286440,7.13974963869064,7.12353637235271,7.10491906568010,7.08348936277929,7.05877616822746,7.03023518276274,6.99723682103389,6.95905224052627,6.91483716965634,6.86361317437192,6.80424594616832,6.73542012873407,6.65561012371985,6.56304622670110,6.45567534153827,6.33111539982852,6.18660247424355,6.01892940948652,5.82437460953037,5.59861939914975,5.33665212317612,5.03265685575934,4.67988424611641,4.27050163366641,3.79541910128192,3.24408760781963,2.60426471084534,1.86174268100224,0.999998681639187,0];
    if TP == 2
        Sact = [0.00500000000000000,0.150422109436167,0.178247312131778,0.208840586922812,0.242005957002388,0.277927118577656,0.316625663226671,0.358490124177871,0.403821829664849,0.452413798581806,0.504512185935594,0.560421948433583,0.620295400232996,0.684142010104812,0.751380744838827,0.821336806809344,0.892578899238426,0.873091510201751,0.928743585309867,0.998864119481270,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1.00000000000000,1,1,1,1,1,1,1,1];
        Scoef = [8.09816979717308,7.86717671753355,7.70745169228281,7.59471181670296,7.51539432965682,7.45603278739704,7.41148310936066,7.37697863776979,7.35092843507473,7.33001885237495,7.31315850846937,7.29931366495796,7.28772165238343,7.27781909941167,7.26919577138500,7.26154681749590,7.25460467668958,7.24814228790651,7.24198678043386,7.23599302887656,7.23001490951914,7.22392958478711,7.21760884891328,7.21091822333522,7.20371471602055,7.19584427483423,7.18713810201958,7.17740907675358,7.16644747749528,7.15401591858535,7.13984439282156,7.12362396566472,7.10499993312769,7.08356393010317,7.05884484527268,7.03029836094649,6.99729477756873,6.95910557158000,6.91488598817571,6.86365764362381,6.80428659664551,6.73545736320188,6.65564380436843,6.56307657795925,6.45570230461661,6.33114000665614,6.18662424273460,6.01894811565953,5.82439170124164,5.59863402660448,5.33666442282919,5.03266697887268,4.67989237055804,4.27050685998202,3.79542363356364,3.24409142565043,2.60426936886728,1.86174320927233,0.999998686388893,0];
    elseif TP == 5
        Sact = [0.00500000000000000,0.149197104355773,0.174804948545350,0.209525602794821,0.239841032278766,0.270585841622324,0.302024462951146,0.334533605939426,0.368513350786121,0.404033212525334,0.441498644861271,0.481527207480298,0.524304045073986,0.569982954265168,0.618706105894638,0.670598905589067,0.725742956856395,0.784027265326779,0.845515981436160,0.910099496396008,0.977653075356065,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];
        Scoef = [8.09857009864588,7.86632038761137,7.70510620828191,7.59605467137417,7.51565609509475,7.45640206667282,7.41185559068634,7.37773588720924,7.35113320022813,7.33000198939413,7.31292972033807,7.29891086200782,7.28719511070908,7.27722266583692,7.26856897040594,7.26090357029661,7.25396349904616,7.24753286773871,7.24142826315416,7.23549079306553,7.22957632799233,7.22354970264658,7.21728062682574,7.21063480281233,7.20346950310543,7.19563174120389,7.18695333408970,7.17724805796939,7.16630671431966,7.15389299396631,7.13973723945648,7.12353025320250,7.10491847165098,7.08349371409368,7.05878428912335,7.03024648171486,6.99725044272734,6.95906899308723,6.91485540708433,6.86363419849901,6.80426836400724,6.73544284742104,6.65563545399061,6.56307223609098,6.45570040092444,6.33114328524508,6.18662845849535,6.01895655108741,5.82440294329412,5.59865157264449,5.33667972934513,5.03268543414936,4.67991816890165,4.27052744092376,3.79544565551660,3.24412169134244,2.60429302305726,1.86176353108682,0.999999071760401,0];
    end
elseif GE == 1
    Dact = [0.00500000000000000,0.144102010165285,0.168904404200184,0.195603996013847,0.223860419284730,0.253564079108770,0.284745372887562,0.317521083618858,0.352012945375904,0.388003868334514,0.425736747778759,0.465748717462727,0.508195650459427,0.553362965204009,0.601268712953387,0.652225838942462,0.706231708224731,0.763545116858974,0.824111569974477,0.888215894338580,0.955808098179736,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];
    Dactg = [0.0723435212887127,0.0991189705848694,0.127407346744709,0.159500671322123,0.194400582236647,0.231080346355471,0.268584921106981,0.306108046103452,0.342920335233904,0.377892048369728,0.410497257868125,0.437451926727356,0.461850482494081,0.483429006478798,0.501797378989473,0.516715590164778,0.527543496475610,0.533822741221233,0.534736416532915,0.529307894740599,0.516114962133098,0.495229624338196,0.472408589471121,0.453927084853735,0.438942268476232,0.425902443617979,0.414630058277154,0.404718087782645,0.395668858130096,0.387407985544756,0.379721440641958,0.372314018244644,0.365385877390266,0.358894664746976,0.352741560028087,0.346522684308799,0.340456268079883,0.334786388646982,0.328875819744355,0.323797879347969,0.317299097421237,0.312455846757716,0.306127376433820,0.300379967822545,0.293983075262832,0.289369620967709,0.282416838741226,0.276573263774986,0.268356203393428,0.262135922330097,0.251452971648405,0.242047419574856,0.230790686829154,0.217601886440522,0.201966674495733,0.182932487201365,0.159762610251168,0.129776627390381,0.0688941030844156,0.0688941030844156];
    Dcoef = [8.09896863936652,7.86780080435733,7.70907180814319,7.59706561757959,7.51616906396886,7.45652667697339,7.41171555152109,7.37743929411910,7.35076132573010,7.32961423472503,7.31256042377414,7.29857147898163,7.28688889837428,7.27694852144448,7.26832287367053,7.26068106458347,7.25376043853456,7.24734640407186,7.24125763280939,7.23533523669869,7.22943436493276,7.22341817548717,7.21715656350200,7.21051660365193,7.20335666558242,7.19552377614938,7.18685021699677,7.17714969695824,7.16621310631674,7.15380374286975,7.13965199785448,7.12344930553209,7.10484124589504,7.08341968920660,7.05871372155903,7.03017919562928,6.99718662420756,6.95900724941807,6.91479689338035,6.86357715133667,6.80421380896862,6.73539151607840,6.65558473447613,6.56302378602458,6.45565561565610,6.33109814614736,6.18658749293628,6.01891652460422,5.82436365528714,5.59861020617895,5.33664455315788,5.03265075868095,4.67987948432272,4.27049806042934,3.79541656708501,3.24408595733057,2.60426377541900,1.86174227578962,0.999998702620505,0];
    if TP == 2
        Sact = [0.00500000000000000,0.148545164865934,0.174880925243178,0.203381312432105,0.233676148058367,0.265641592184702,0.299240113322267,0.334533023192859,0.371608177902446,0.410105767185412,0.450185769103262,0.492507037584041,0.537318703123488,0.584706048011017,0.634934438600044,0.688182964835799,0.744577005083591,0.801725745414562,0.859792380872967,0.918492021940935,0.979174732497866,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];
        Sactg = [0.0770298118400625,0.106316544992020,0.137637028744943,0.173491385827711,0.212810421442218,0.254362778689972,0.297000991987885,0.339654452543565,0.381381712434933,0.420510443545969,0.456169122733093,0.485245305747277,0.510998099287183,0.533044113619036,0.551043437798086,0.564538897755799,0.572913059948748,0.567499125594286,0.552181707611635,0.525027286624178,0.491247468865976,0.472672953096033,0.454158527067963,0.438844753778583,0.426028536648373,0.415061109792309,0.405538077068004,0.397035396639962,0.389347492170507,0.382435355239463,0.375912920137095,0.370005192613958,0.364332268955606,0.359001478314892,0.353784666868293,0.348850039492193,0.343885462301401,0.339313418485608,0.334951994765434,0.330120562708786,0.325622534858419,0.320723995813000,0.316384290549868,0.311746276044466,0.306433044266871,0.301700288006563,0.297089350475204,0.290206792775226,0.283651817083824,0.276283292201963,0.267573155962883,0.257588854540803,0.247103085738087,0.232578622611465,0.216526802611829,0.196248190841140,0.170102278953345,0.136103558109073,0.0637085742882562,0.0637085742882562];
        Scoef = [8.09790994681991,7.86744507022552,7.70880723405568,7.59686853156310,7.51601886995425,7.45640524724353,7.41160912150652,7.37733928765673,7.35066142729397,7.32950884716823,7.31244469834023,7.29845138108270,7.28676824591544,7.27683125273840,7.26821188245027,7.26058179261843,7.25367490124217,7.24727717004420,7.24120391700110,7.23529238130550,7.22940203112569,7.22339460889333,7.21714097850879,7.21050775067771,7.20335321903849,7.19552460049792,7.18685432904261,7.17715631174270,7.16622160751012,7.15381361185900,7.13966284134258,7.12346079085780,7.10485315438759,7.08343173603306,7.05872585204539,7.03019120133157,6.99719835051400,6.95901873583953,6.91480806147242,6.86358798570947,6.80422432357628,6.73540153411103,6.65559422804267,6.56303273071569,6.45566398891773,6.33110577822524,6.18659496182069,6.01892338508442,5.82436958660569,5.59861581041433,5.33664981833200,5.03265614348605,4.67988348249047,4.27050174858947,3.79541990915188,3.24408892145895,2.60426729652550,1.86174321901384,0.999998702425424,0];
    elseif TP == 5
        Sact = [0.00500000000000000,0.149201335821329,0.174817092885074,0.202403513532174,0.231616563639604,0.262350512859019,0.294565759110143,0.328415920689055,0.364003016581785,0.401017844535880,0.439753515189338,0.480696083064901,0.524091571436063,0.570101078146517,0.618936401763113,0.670683980282072,0.725566641014234,0.783181789135978,0.840819174781816,0.898905729469347,0.962491108112786,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0.999999999999862,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];
        Sactg = [0.0781396927723213,0.106803779715311,0.136891049703568,0.171060206931610,0.208237275424630,0.247306667300252,0.287181973641251,0.327013349025782,0.365976031686681,0.402683292193732,0.436621822314253,0.464224105680282,0.488845372441494,0.510176018400056,0.527908894295084,0.541607610906085,0.550740091613380,0.553555547471568,0.541796316550777,0.519142994886782,0.496943170767960,0.478455228438866,0.457747375500648,0.440823001176502,0.426479816380466,0.414322038036116,0.403595928448905,0.394165546901667,0.385469465211679,0.377597188830861,0.370435513492782,0.363303359655537,0.356684953182351,0.350290045575276,0.344257044059593,0.338853059279638,0.332931470582347,0.327385093343241,0.322158278552871,0.316711275406642,0.311690204108947,0.306334509971217,0.301195743709445,0.295630773262942,0.290674315132733,0.284802692703514,0.279491378255372,0.273136617216311,0.265304554755458,0.258592701836705,0.250107933349972,0.241520386902151,0.230573152016148,0.217012021495475,0.202158875571652,0.183048867551557,0.160571468492385,0.130796537293077,0.0666191224237192,0.0666191224237192];
        Scoef = [8.09908325012652,7.86794525383880,7.70921724644158,7.59719356239519,7.51627035405118,7.45565972894793,7.41158928714402,7.37737993687478,7.35074486215718,7.32961852359376,7.31256987279391,7.29858093110425,7.28689561557156,7.27695286614347,7.26832742777270,7.26068841953566,7.25377141975836,7.24736226940570,7.24127930697859,7.23536286582453,7.22946679720023,7.22345332631040,7.21719338036592,7.21055433340297,7.20339463289035,7.19556147574602,7.18688750561637,7.17718638384097,7.16624907755972,7.15383891160744,7.13968648410351,7.12348260304210,7.10487392050021,7.08345111478491,7.05874437236111,7.03020945383642,6.99721550290399,6.95903550410930,6.91482512063575,6.86360436738293,6.80423929263189,6.73541743237560,6.65560952838461,6.56304731837000,6.45567647878214,6.33111874359617,6.18660793987203,6.01893886735207,5.82438165774127,5.59863077879272,5.33666251653245,5.03266169219353,4.67989012284756,4.27050853674376,3.79542687860252,3.24410261440566,2.60426611587121,1.86174379165119,0.999998702238092,0];
    elseif TP == 7
        Sact = [0.00500000000000000,0.174968147285382,0.201743999182262,0.230617161400186,0.261259310174021,0.293514711588031,0.327383598919311,0.362959415501579,0.400290908134769,0.382387607043062,0.420448665291181,0.460510793802629,0.502910339233563,0.547891121777337,0.595533723451556,0.646166993964973,0.699825158260976,0.756744168062525,0.816942454412037,0.880548607422183,0.947593964178130,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];
        Sactg = [0.104824047495066,0.137114524030216,0.169243756469038,0.205523651131797,0.244744082066513,0.285678265644937,0.327171584181915,0.368251798699481,0.408011798937826,0.351476552605341,0.390463794114287,0.421946028519007,0.449506690889214,0.473394889259196,0.493502144721555,0.509748074659041,0.521823075809998,0.529173294095130,0.531136548411081,0.526643988619543,0.514600780270243,0.494421574436404,0.470873575555535,0.452168081820715,0.436614485269836,0.423616354161656,0.412254734072153,0.402083218858688,0.393119264582555,0.384633924328197,0.377135846323734,0.369738086488960,0.362695612298130,0.356280587495257,0.350270002276021,0.343724729667827,0.337824942916262,0.331950130660377,0.326226662964333,0.320786025912100,0.315535091762148,0.309629118592471,0.304124306174059,0.298212514821258,0.292546734911766,0.286056812141971,0.280551416531009,0.274861181221605,0.266705114349240,0.258820924604461,0.250300218854058,0.240845671867608,0.229121748455720,0.216644237257660,0.200484835529156,0.182857105152027,0.158451946472019,0.128899652548887,0.0681901377792861,0.0681901377792861];
        Scoef = [8.09526995865637,7.86882371270681,7.70936446631449,7.59781786264428,7.51678309727301,7.45700975833247,7.41208642031319,7.37513691139675,7.34812932552584,7.33008590683710,7.31302796374636,7.29901125236347,7.28729350623826,7.27731864356873,7.26866150630486,7.26099179413196,7.25404535713705,7.24760876608753,7.24149813484946,7.23555495244214,7.22963642008975,7.22360378726770,7.21732647064883,7.21067180790493,7.20349836280934,7.19565312422814,7.18696837981854,7.17725775723974,7.16631193175244,7.15389424947890,7.13973499089829,7.12352535244307,7.10491105843480,7.08348382590372,7.05877274865299,7.03023333566275,6.99723652260790,6.95905308449235,6.91483896556929,6.86361575633609,6.80424916824797,6.73542386417419,6.65561425496495,6.56305065301423,6.45567996033325,6.33112012128783,6.18660719374339,6.01893352421648,5.82437898559433,5.59862479563080,5.33665634725718,5.03266224754657,4.67988900750883,4.27050556107332,3.79542056673153,3.24409083209204,2.60426448468132,1.86174251908304,0.999998670182463,0];
    end
end
   
ag1 = 0.1;

if GE == 2
    for t=1:1:10
        [Sd(:, t + 1), SCostd(1:2, t)] = Rep_NextState(Sd(:, t), Dact(t), t,  Wm, 0);
        [Ss(:, t + 1), SCosts(1:2, t)] = Rep_NextState(Ss(:, t), Sact(t), t,  Wm, 0);
        deltaa0 = Dact(t);       
        deltaa = Sact(t);

        u0 = Rep_Utility(Sd(:, t), deltaa0,  Wm, t);
        u1 = Rep_Utility(Ss(:, t), deltaa,  Wm, t);

        S010 = Rep_NextState(Sd(:, t), deltaa0, t, Wm, 0);
        S011 = Rep_NextState(Sd(:, t), deltaa0, t, Wm, TP);        
        S10 = Rep_NextState(Sd(:, t), deltaa, t, Wm, 0);
        S11 = Rep_NextState(Sd(:, t), deltaa, t, Wm, TP);

        ptx01 = max(0, (min(S010(2), TrigTemp) - Sd(2, t))/(TrigTemp - Sd(2, t)));
        ptx1 = max(0, (min(S10(2), TrigTemp) - Sd(2, t))/(TrigTemp - Sd(2, t)));

        S0200 = Rep_NextState(S010, aa0, t + 1, Wm, 0);
        S0201 = Rep_NextState(S010, aa0, t + 1, Wm, TP);
        S0211 = Rep_NextState(S011, aa0, t + 1, Wm, TP);
        S200 = Rep_NextState(S10, aa0, t + 1, Wm, 0);
        S201 = Rep_NextState(S10, aa0, t + 1, Wm, TP);
        S211 = Rep_NextState(S11, aa0, t + 1, Wm, TP);

        ptx02 = max(0, (min(S0200(2), TrigTemp) - S010(2))/(TrigTemp - S010(2)));
        ptx2 = max(0, (min(S200(2), TrigTemp) - S10(2))/(TrigTemp - S10(2)));

        U00 = (1 - ptx02) * Rep_Utility(S0200, aa0, Wm, t + 2) + ptx02 * Rep_Utility(S0201, aa0, Wm, t + 2); 
        U01 = Rep_Utility(S0211, aa0, Wm, t + 2);
        U0 = (1 - ptx2) * Rep_Utility(S200, aa0, Wm, t + 2) + ptx2 * Rep_Utility(S201, aa0, Wm, t + 2); 
        U1 = Rep_Utility(S211, aa0, Wm, t + 2);

        D1a(t) = u0 - lambda * Dcoef(t) * (U0 - U00);
        DWIa(t) = u0 - lambda * ptx01 *  Dcoef(t) * ((U1 - U01) - (U0 - U00));
        MHEa(t) = u0 - lambda * (ptx1 - ptx01) * Dcoef(t) * (U1 - U0);

        Abt(t, 1) = bprice(t) * 1000 * ((((1 - SCostd(1, t)) * (10 * L(t) - u0) * 780 * Sd(7, t) - 10 * L(t)^2)/((10 * L(t) - u0) * 780 * Sd(7, t) * theta1(t)))^(1/theta2))^(theta2 - 1);
        Abt(t, 2) = bprice(t) * 1000 * ((((1 - SCostd(1, t)) * (10 * L(t) - D1a(t)) * 780 * Sd(7, t) - 10 * L(t)^2)/((10 * L(t) - D1a(t)) * 780 * Sd(7, t) * theta1(t)))^(1/theta2))^(theta2 - 1) - Abt(t, 1);
        Abt(t, 3) = bprice(t) * 1000 * ((((1 - SCostd(1, t)) * (10 * L(t) - DWIa(t)) * 780 * Sd(7, t) - 10 * L(t)^2)/((10 * L(t) - DWIa(t)) * 780 * Sd(7, t) * theta1(t)))^(1/theta2))^(theta2 - 1) - Abt(t, 1);
        Abt(t, 4) = bprice(t) * 1000 * ((((1 - SCostd(1, t)) * (10 * L(t) - MHEa(t)) * 780 * Sd(7, t) - 10 * L(t)^2)/((10 * L(t) - MHEa(t)) * 780 * Sd(7, t) * theta1(t)))^(1/theta2))^(theta2 - 1) - Abt(t, 1);
        Abt(t, 5) = bprice(t) * 1000 * ((((1 - SCosts(1, t)) * (10 * L(t) - u1) * 780 * Ss(7, t) - 10 * L(t)^2)/((10 * L(t) - u1) * 780 * Ss(7, t) * theta1(t)))^(1/theta2))^(theta2 - 1);

    end
else
    for t=1:1:15
        [Sd(:, t + 1), SCostd(:, t)] = T_G_NextState(Sd(:, t), Dact(t), Dactg(t), t, deltaT, nuG, Wm, 0);
        [Ss(:, t + 1), SCosts(:, t)] = T_G_NextState(Ss(:, t), Sact(t), Sactg(t), t, deltaT, nuG, Wm, 0);
        deltaa0 = Dact(t);
        deltag0 = Dactg(t); 
        deltaa = Sact(t);
        deltag = Sactg(t);

        u0 = T_G_Utility(Sd(:, t), deltaa0, deltag0, Wm, t);
        u1g = T_G_Utility(Sd(:, t), deltaa0, deltag, Wm, t);

        [S010, Scost0] = T_G_NextState(Sd(:, t), deltaa0, deltag0, t, deltaT, nuG, Wm, 0);
        S011 = T_G_NextState(Sd(:, t), deltaa0, deltag0, t, deltaT, nuG, Wm, TP);

        [Sa10, Scosta0] = T_G_NextState(Sd(:, t), deltaa, deltag0, t, deltaT, nuG, Wm, 0);
        Sa11 = T_G_NextState(Sd(:, t), deltaa, deltag0, t, deltaT, nuG, Wm, TP);

        [Sg10, Scostg0] = T_G_NextState(Sd(:, t), deltaa0, deltag, t, deltaT, nuG, Wm, 0);
        Sg11 = T_G_NextState(Sd(:, t), deltaa0, deltag, t, deltaT, nuG, Wm, TP);            

        ptx01 = max(0, (min(S010(2), TrigTemp) - Sd(2, t))/(TrigTemp - Sd(2, t)));
        ptxa1 = max(0, (min(Sa10(2), TrigTemp) - Sd(2, t))/(TrigTemp - Sd(2, t)));
        ptxg1 = max(0, (min(Sg10(2), TrigTemp) - Sd(2, t))/(TrigTemp - Sd(2, t)));

        S0200 = T_G_NextState(S010, aa0, ag0, t + 1, deltaT, nuG, Wm, 0);
        S0201 = T_G_NextState(S010, aa0, ag0, t + 1, deltaT, nuG, Wm, TP);
        S0211 = T_G_NextState(S011, aa0, ag0, t + 1, deltaT, nuG, Wm, TP);

        Sa200 = T_G_NextState(Sa10, aa0, ag0, t + 1, deltaT, nuG, Wm, 0);
        Sa201 = T_G_NextState(Sa10, aa0, ag0, t + 1, deltaT, nuG, Wm, TP);
        Sa211 = T_G_NextState(Sa11, aa0, ag0, t + 1, deltaT, nuG, Wm, TP);

        Sg200 = T_G_NextState(Sg10, aa0, ag0, t + 1, deltaT, nuG, Wm, 0);
        Sg201 = T_G_NextState(Sg10, aa0, ag0, t + 1, deltaT, nuG, Wm, TP);
        Sg211 = T_G_NextState(Sg11, aa0, ag0, t + 1, deltaT, nuG, Wm, TP);            

        ptx02 = max(0, (min(S0200(2), TrigTemp) - S010(2))/(TrigTemp - S010(2)));
        ptxa2 = max(0, (min(Sa200(2), TrigTemp) - Sa10(2))/(TrigTemp - Sa10(2)));
        ptxg2 = max(0, (min(Sg200(2), TrigTemp) - Sg10(2))/(TrigTemp - Sg10(2)));

        U00 = (1 - ptx02) * T_G_Utility(S0200, aa0, ag0, Wm, t + 2) + ptx02 * T_G_Utility(S0201, aa0, ag0, Wm, t + 2); 
        U01 = T_G_Utility(S0211, aa0, ag0, Wm, t + 2);

        Ua0 = (1 - ptxa2) * T_G_Utility(Sa200, aa0, ag0, Wm, t + 2) + ptxa2 * T_G_Utility(Sa201, aa0, ag0, Wm, t + 2); 
        Ua1 = T_G_Utility(Sa211, aa0, ag0, Wm, t + 2);

        Ug0 = (1 - ptxg2) * T_G_Utility(Sg200, aa0, ag0, Wm, t + 2) + ptxg2 * T_G_Utility(Sg201, aa0, ag0, Wm, t + 2); 
        Ug1 = T_G_Utility(Sg211, aa0, ag0, Wm, t + 2);

        d0 = 10 * L(t) * (1 - L(t)/(780 * Sd(7, t) * (1 - (Scost0(1) + Scost0(2) + Scost0(3)))));
        
        D1a(t) = u0 - lambda * Dcoef(t) * (Ua0 - U00);
        DWIa(t) = u0 - lambda * ptx01 *  Dcoef(t) * ((Ua1 - U01) - (Ua0 - U00));
        MHEa(t) = u0 - lambda * (ptxa1 - ptx01) * Dcoef(t) * (Ua1 - Ua0);
        da = 10 * L(t) * (1 - L(t)/(780 * Sd(7, t) * (1 - (Scosta0(1) + Scost0(2) + Scost0(3)))));
        IDRa(t) = u0 - (da - d0);
        
        D1g(t) = u0 - lambda * Dcoef(t) * (Ug0 - U00);
        DWIg(t) = u0 - lambda * ptx01 *  Dcoef(t) * ((Ug1 - U01) - (Ug0 - U00));
        MHEg(t) = u0 - lambda * (ptxg1 - ptx01) * Dcoef(t) * (Ug1 - Ug0);
        dg = 10 * L(t) * (1 - L(t)/(780 * Sd(7, t) * (1 - (Scostg0(1) + Scost0(2) + Scost0(3)))));
        IDRg(t) = u0 - (dg - d0);

        Abt(t, 1) = ((((1 - (SCostd(1, t) + SCostd(3, t))) * (10 * L(t) - u0) * 780 * Sd(7, t) - 10 * L(t)^2)/((10 * L(t) - u0) * 780 * Sd(7, t) * theta1(t)))^(1/theta2));
        Abt(t, 2) = ((((1 - (SCostd(1, t) + SCostd(3, t))) * (10 * L(t) - D1a(t)) * 780 * Sd(7, t) - 10 * L(t)^2)/((10 * L(t) - D1a(t)) * 780 * Sd(7, t) * theta1(t)))^(1/theta2)) - Abt(t, 1);
        Abt(t, 3) = ((((1 - (SCostd(1, t) + SCostd(3, t))) * (10 * L(t) - DWIa(t)) * 780 * Sd(7, t) - 10 * L(t)^2)/((10 * L(t) - DWIa(t)) * 780 * Sd(7, t) * theta1(t)))^(1/theta2)) - Abt(t, 1);
        Abt(t, 4) = ((((1 - (SCostd(1, t) + SCostd(3, t))) * (10 * L(t) - MHEa(t)) * 780 * Sd(7, t) - 10 * L(t)^2)/((10 * L(t) - MHEa(t)) * 780 * Sd(7, t) * theta1(t)))^(1/theta2)) - Abt(t, 1);
        Abt(t, 5) = ((((1 - (SCostd(1, t) + SCostd(3, t))) * (10 * L(t) - IDRa(t)) * 780 * Sd(7, t) - 10 * L(t)^2)/((10 * L(t) - IDRa(t)) * 780 * Sd(7, t) * theta1(t)))^(1/theta2)) - Abt(t, 1);
        Abt(t, 6) = ((((1 - (SCostd(1, t) + SCostd(2, t))) * (10 * L(t) - u0) * 780 * Sd(7, t) - 10 * L(t)^2)/((10 * L(t) - u0) * 780 * Sd(7, t) * thetaGE))^(1/theta3));
        
        fun7 = @(x) myf(x, D1g(t));
        Abt(t, 7) = fzero(fun7, Dactg(t)) - Abt(t, 6);
        
        fun8 = @(x) myf(x, DWIg(t));
        Abt(t, 8) = fzero(fun8, Dactg(t)) - Abt(t, 6);
        
        fun9 = @(x) myf(x, MHEg(t));
        Abt(t, 9) = fzero(fun9, Dactg(t)) - Abt(t, 6);
        
        fun10 = @(x) myf(x, IDRg(t));
        Abt(t, 10) = fzero(fun10, Dactg(t)) - Abt(t, 6);
        
%         Abt(t, 7) = ((((1 - (SCostd(1, t) + SCostd(2, t))) * (10 * L(t) - D1g(t)) * 780 * Sd(7, t) - 10 * L(t)^2)/((10 * L(t) - D1g(t)) * 780 * Sd(7, t) * thetaGE))^(1/theta3)) - Abt(t, 6);
%         Abt(t, 8) = ((((1 - (SCostd(1, t) + SCostd(2, t))) * (10 * L(t) - DWIg(t)) * 780 * Sd(7, t) - 10 * L(t)^2)/((10 * L(t) - DWIg(t)) * 780 * Sd(7, t) * thetaGE))^(1/theta3)) - Abt(t, 6);
%         Abt(t, 9) = ((((1 - (SCostd(1, t) + SCostd(2, t))) * (10 * L(t) - MHEg(t)) * 780 * Sd(7, t) - 10 * L(t)^2)/((10 * L(t) - MHEg(t)) * 780 * Sd(7, t) * thetaGE))^(1/theta3)) - Abt(t, 6);
%         Abt(t, 10) = -(((((1 - (SCostd(1, t) + SCostd(2, t))) * (10 * L(t) - IDRg(t)) * 780 * Sd(7, t) - 10 * L(t)^2)/((10 * L(t) - IDRg(t)) * 780 * Sd(7, t) * thetaGE))^(1/theta3)) - Abt(t, 6));
    end
end